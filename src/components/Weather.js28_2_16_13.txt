import React, { useState, useEffect } from "react";

const Weather = () => {
  const [weatherData, setWeatherData] = useState(null);
  const [forecastData, setForecastData] = useState([]);
  const [error, setError] = useState(null);
  const [searchLocation, setSearchLocation] = useState("");
  const [currentIndex, setCurrentIndex] = useState(0);

  const fetchWeather = async (query) => {
    try {
      console.log("ğŸ” LÃ¤hetetÃ¤Ã¤n sÃ¤Ã¤pyyntÃ¶ backendille:", query);

      const weatherResponse = await fetch(`http://localhost:8000/fishing/weather/${query}/`);
      if (!weatherResponse.ok) throw new Error("Virhe haettaessa sÃ¤Ã¤tietoja");
      const weatherData = await weatherResponse.json();

      console.log("âœ… Nykyinen sÃ¤Ã¤ JSON:", weatherData);
      if (!weatherData || !weatherData.sÃ¤Ã¤) throw new Error("SÃ¤Ã¤datan haku epÃ¤onnistui");

      setWeatherData(weatherData);

      const forecastResponse = await fetch(`http://localhost:8000/fishing/forecast/${query}/`);
      if (!forecastResponse.ok) throw new Error("Virhe haettaessa sÃ¤Ã¤ennustetta");
      const forecastData = await forecastResponse.json();

      console.log("âœ… Ennuste JSON:", forecastData);
      if (!forecastData || !forecastData.ennuste) throw new Error("SÃ¤Ã¤ennusteen haku epÃ¤onnistui");

      // ğŸ› ï¸ JÃ¤rjestetÃ¤Ã¤n ennuste pÃ¤ivÃ¤mÃ¤Ã¤rÃ¤n mukaan (jos JSON antaa ne vÃ¤Ã¤rÃ¤ssÃ¤ jÃ¤rjestyksessÃ¤)
      const sortedForecast = forecastData.ennuste.sort((a, b) => new Date(a.pÃ¤ivÃ¤mÃ¤Ã¤rÃ¤) - new Date(b.pÃ¤ivÃ¤mÃ¤Ã¤rÃ¤));

      // ğŸ› ï¸ Poistetaan duplikaatit ja yhdistetÃ¤Ã¤n saman pÃ¤ivÃ¤n tiedot keskiarvoksi
      const processedForecast = sortedForecast.reduce((acc, item) => {
        const existing = acc.find(f => f.pÃ¤ivÃ¤mÃ¤Ã¤rÃ¤ === item.pÃ¤ivÃ¤mÃ¤Ã¤rÃ¤);
        if (existing) {
          existing.lÃ¤mpÃ¶tila = (existing.lÃ¤mpÃ¶tila + item.lÃ¤mpÃ¶tila) / 2;
        } else {
          acc.push(item);
        }
        return acc;
      }, []);

      setForecastData(processedForecast);
      setCurrentIndex(0);
    } catch (error) {
      console.error("âŒ Virhe haettaessa sÃ¤Ã¤tietoja:", error);
      setError(error.message || "Tuntematon virhe");
    }
  };

  const handleSearch = () => {
    if (searchLocation) {
      setWeatherData(null);
      setForecastData([]);
      setCurrentIndex(0);
      fetchWeather(searchLocation);
    }
  };

useEffect(() => {
  fetchWeather("Helsinki");
}, []);



const nextDay = () => {
  setCurrentIndex((prevIndex) => {
    const newIndex = Math.min(prevIndex + 1, forecastData.length - 1);
    console.log("â¡ Seuraava pÃ¤ivÃ¤:", forecastData[newIndex]?.pÃ¤ivÃ¤mÃ¤Ã¤rÃ¤);
    return newIndex;
  });
};

const prevDay = () => {
  setCurrentIndex((prevIndex) => {
    const newIndex = Math.max(prevIndex - 1, 0);
    console.log("â¬… Edellinen pÃ¤ivÃ¤:", forecastData[newIndex]?.pÃ¤ivÃ¤mÃ¤Ã¤rÃ¤);
    return newIndex;
  });
};

  if (error) {
    return <p style={{ color: "red" }}>{error}</p>;
  }

  if (!weatherData) {
    return <p>Ladataan sÃ¤Ã¤tietoja...</p>;
  }

  return (
    <div>
      <h2>SÃ¤Ã¤ennuste: {weatherData.kaupunki}</h2>
      <p>LÃ¤mpÃ¶tila: {weatherData.lÃ¤mpÃ¶tila}Â°C</p>
      <p>Tuntuu kuin: {weatherData.tuntuu_kuin}Â°C</p>
      <p>Ilmanpaine: {weatherData.ilmanpaine} hPa</p>
      <p>Kosteus: {weatherData.kosteus}%</p>
      <p>Tuuli: {weatherData.tuuli_nopeus} m/s, suunta {weatherData.tuuli_suunta}Â°</p>
      <p><strong>SÃ¤Ã¤:</strong> {weatherData.sÃ¤Ã¤}</p>

      {/* ğŸ” Haku */}
      <input
        type="text"
        placeholder="Hae kaupunki..."
        value={searchLocation}
        onChange={(e) => setSearchLocation(e.target.value)}
        onKeyDown={(e) => e.key === "Enter" && handleSearch()}
      />
      <button onClick={handleSearch}>Hae</button>

      {/* ğŸ”¥ 6 pÃ¤ivÃ¤n ennuste vieritettÃ¤vÃ¤nÃ¤ */}
      {forecastData.length > 0 && (
        <div>
          <h3>PÃ¤ivÃ¤mÃ¤Ã¤rÃ¤: {forecastData[currentIndex]?.pÃ¤ivÃ¤mÃ¤Ã¤rÃ¤}</h3>
          <p>LÃ¤mpÃ¶tila: {forecastData[currentIndex]?.lÃ¤mpÃ¶tila.toFixed(1)}Â°C</p>
          <p>SÃ¤Ã¤: {forecastData[currentIndex]?.sÃ¤Ã¤}</p>

          <button onClick={prevDay} disabled={currentIndex === 0}>â† Edellinen</button>
          <button onClick={nextDay} disabled={currentIndex === forecastData.length - 1}>Seuraava â†’</button>
        </div>
      )}
    </div>
  );
};

export default Weather;



